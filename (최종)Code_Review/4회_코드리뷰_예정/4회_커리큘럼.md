# 4회차 코드리뷰 커리큘럼: Django 트랜잭션과 동시성 제어

본 커리큘럼은 주니어 개발자 2명을 대상으로 하며, Django의 트랜잭션 관리와 데이터베이스 동시성 제어(Concurrency Control)를 체계적으로 학습하기 위해 구성되었습니다.

## 📌 학습 목표
- Django ORM의 트랜잭션 기본 동작(`atomic`, `savepoint`) 이해
- 동시성 문제 해결을 위한 잠금(Locking) 전략(`select_for_update`) 습득
- 실무에서 자주 쓰이는 트랜잭션 패턴(Retry, Outbox, `on_commit`) 익히기

---

## 📚 학습 순서 (Curriculum)

학습 효과를 극대화하기 위해 아래 순서대로 코드를 분석하고 토론하는 것을 권장합니다.

- 순서:

1. 모델링 (model.py): 기본 테이블 구조 파악
2. 트랜잭션 기초 (tx_basic.py): atomic, select_for_update, Savepoint
3. 동시성 제어 심화 (tx_concurrency.py): Deadlock 방지, nowait, skip_locked
4. 트랜잭션 훅 (tx_on_commit.py): Outbox 패턴과 on_commit
5. 에러 핸들링 (tx_retry.py): DB 일시적 오류에 대한 Retry 데코레이터
6. 테스트 (tests_tx.py): 트랜잭션 롤백 및 동작 검증 테스트

### 1. Data Modeling & Schema
- **File**: `model.py`
- **난이도**: ⭐ (쉬움)
- **학습 포인트**:
  - 이번 리뷰에서 사용할 테이블 구조 파악
  - `Product`(상품), `Order`(주문), `Ledger`(장부), `OutboxEvent`(이벤트) 간의 관계 이해
  - `UUIDField`, `DecimalField` 등 필드 타입 선정 이유 살펴보기

### 2. Transaction Basics & Locking
- **File**: `tx_basic.py`
- **난이도**: ⭐⭐ (보통)
- **학습 포인트**:
  - `@transaction.atomic`을 이용한 원자성 보장
  - `select_for_update()`를 이용한 배타적 잠금(Pessimistic Lock)으로 재고 차감 동시성 문제 해결
  - `F()` 객체를 이용한 DB 레벨 연산
  - 중첩 트랜잭션(Savepoint)을 이용한 부분 롤백 처리 (`charge_and_log` 함수)

### 3. Advanced Concurrency Patterns
- **File**: `tx_concurrency.py`
- **난이도**: ⭐⭐⭐ (약간 어려움)
- **학습 포인트**:
  - `nowait=True`: 잠금 대기 없이 즉시 실패 처리하기
  - **Deadlock Prevention**: 자원 접근 순서 정렬(Ordering)을 통한 교착 상태 예방
  - `skip_locked=True`: (PostgreSQL 전용) 배치 처리를 위한 병렬 작업 큐 패턴 구현

### 4. Transaction Hooks & Patterns
- **File**: `tx_on_commit.py`
- **난이도**: ⭐⭐ (보통)
- **학습 포인트**:
  - `transaction.on_commit()`: 트랜잭션이 **성공적으로 커밋된 후**에만 실행되어야 하는 로직 (예: 알림 발송)
  - **Transactional Outbox Pattern**: 데이터 변경과 이벤트 발행을 하나의 트랜잭션으로 묶어 데이터 일관성 보장

### 5. Reliability & Error Handling
- **File**: `tx_retry.py`
- **난이도**: ⭐⭐⭐⭐ (어려움)
- **학습 포인트**:
  - 데드락(Deadlock)이나 직렬화 실패(Serialization Failure)와 같은 "일시적 DB 에러" 식별
  - `functools.wraps`와 데코레이터를 이용한 **재시도(Retry) 로직** 구현
  - 지수 백오프(Exponential Backoff) 전략 적용

### 6. Testing Transactions
- **File**: `tests_tx.py`
- **난이도**: ⭐⭐ (보통)
- **학습 포인트**:
  - `pytest.mark.django_db(transaction=True)`: 테스트에서 실제 트랜잭션 동작 검증
  - 예외 발생 시 전체 롤백 여부(`count() == 0`) 검증
  - Savepoint 동작 테스트 방법

---

## 💡 리뷰 진행 팁 (Trainer Note)
1. **`tx_basic.py`** 에서 `select_for_update`가 없을 때 발생할 수 있는 **동시성 이슈(Race Condition)** 에 대해 먼저 질문하고, 코드가 어떻게 그것을 방지하는지 설명하게 하세요.
2. **`tx_concurrency.py`** 의 데드락 예방 예시에서, "왜 정렬(sorting)이 데드락을 막아주는지" 원리를 그림으로 그려보게 하면 좋습니다.
3. **`tx_retry.py`** 는 실제 운영 환경에서 매우 중요하므로, 어떤 상황에서 DB 에러가 발생할 수 있는지 경험담을 공유해주시면 좋습니다.
